<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Add BoENG Rule</title>

<link rel="shortcut icon" href="favicon.ico">
<link href="css/bootstrap.min.css?v=3.3.7" rel="stylesheet">
<link href="css/font-awesome.css?v=4.4.0" rel="stylesheet">
<link href="css/plugins/iCheck/custom.css" rel="stylesheet">
<link href="css/animate.css" rel="stylesheet">
<link rel="stylesheet" href="css/bootstrap-select.css">
<link href="css/style1.css" rel="stylesheet">
<link href="css/style_addon.css" rel="stylesheet">

</head>

<body class="gray-bg">
<div class="loader-container" id="preloader">
    <div class="bouncing-dots">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
    </div>
</div>
<div style="display:none;" id="mainpart" class="wrapper wrapper-content animated fadeInRight">
    <form class="form-horizontal" role="form" name="formxl" enctype="multipart/form-data">
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title" >
                    <h5 class="modal-title mx-auto" align="center"><font size= 4 color=brown >Input information</font></h5>
                </div>    
                                            
                <div class="ibox-content"> 
                    <div class="form-group">
                        <label class="col-sm-2 control-label">Customer<span id="alert_Customer"></span></label>
                        <div class="col-sm-5">
                            <select  class='form-control boengDropDown' name="Customer" id="Customer">
                            <option value=""></option> 
                            </select>
                            <div class="errorValidation" id="error_Customer">Customer is required</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">Device Model<font color="#FF0000"></font></label>
                        <div class="col-sm-5">
                            <select  class='form-control boengDropDown' name="device" id="device" >
                            <option value=""></option> 
                            </select>
                            <div class="errorValidation" id="error_device">Device Model is required</div>                                                  
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">Operator ID<font color="#FF0000"></font></label>
                        <div class="col-sm-3">
                            <select  class='form-control boengDropDown' name="OPID" id="OPID">
                                <option value=""></option> 
                            </select>
                            <div class="errorValidation" id="error_OPID">Operator ID is required</div> 
                        </div>
                    </div>
                    <div class="form-group">                            
                        <label class="col-sm-2 control-label">Whitelisting method<font color="#FF0000"></font></label>
                        <div class="col-sm-3">
                            <select class="input-sm boengDropDown" name='whitelistmethod' id='whitelistmethod'>
                                <option value='' selected="selected"></option>
                                <option value="Dedicated OPID" >Dedicated OPID</option>
                                <option value="Country ID" >Country ID</option>
                                <option value="IP based" >IP based</option>             
                                <option value="Serial number" >Serial number</option>    
                            </select>
                            <div class="errorValidation" id="error_whitelistmethod">Whitelisting method is required</div>
                        </div>
                        <div name="country_id" id="country_id">
                            <label class="col-sm-2 control-label">Country ID<font color="#FF0000"></font></label>
                            <div class="col-sm-3">
                                <input type="text" class="form-control" name="countryid" id="countryid" value=''  >
                                <div class="errorValidation" id="error_countryid">Country ID is required</div>
                            </div>
                        </div>
                        <div name="ip_range" id="ip_range">
                            <label class="col-sm-2 control-label">IP ranges<font color="#FF0000"></font></label>
                            <div class="col-sm-3">
                                <input type="text" class="form-control" name="iprange" id="iprange" value=''  >
                                <div class="errorValidation" id="error_iprange">IP ranges is required</div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group col-sm-12" name="serial_number" id="serial_number">
                        <label class="col-sm-2 control-label">Customer name as used in deployment reports for automated whitelisting<font color="#FF0000"></font></label>
                        <div class="col-sm-3">
                            <input type="text" class="form-control" name="customer_name" id="customer_name" value=''  >
                            <div class="errorValidation" id="error_customer_name">Either Customer or CSV file is required</div>
                        </div>
                        <label class="col-sm-2 control-label">CSV file with serial numbers to be whitelisted in case of trial instance or automated whitelisting is not possible<font color="#FF0000"></font></label>
                        <div class="col-sm-3">
                            <input type="file" class="form-control-file" name="csv_file" id="csv_file" style="display: none;" accept=".csv">
                            <label for="csv_file" class="info whitetext" id="csv_file_label">Click to upload CSV</label> 
                        </div>
                        <div class="col-sm-1">
                            <div id="csv_url"></div>
                        </div>
                    </div>

                    <div class="form-group">                            
                        <label class="col-sm-2 control-label">BoENG Options<font color="#FF0000"></font></label>
                        <div class="input-group col-sm-5">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="tr069">
                                <label class="form-check-label" for="flexSwitchCheckDefault">TR-069/ACS</label>
                            </div>                            
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="home_controller">
                                <label class="form-check-label" for="flexSwitchCheckDefault">Home Controller USP Agent</label>
                            </div>                            
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="rd_party_controller">
                                <label class="form-check-label" for="flexSwitchCheckDefault">3rd party USP Controller</label>
                            </div>
                            <div class="errorValidation" id="error_boeng_option">At least one BoENG Option is required</div>
                        </div>
                    </div>

                    <div class="form-group">                            
                        <div class="col-sm-12" name="tr069_acs" id="tr069_acs">
                            <label class="col-sm-2 control-label">ACS URL<font color="#FF0000"></font></label>
                            <div class="col-sm-3">
                                <input type="text" class="form-control" name="acs_url" id="acs_url" value=''  >
                                <div class="errorValidation" id="error_acs_url">ACS URL is required</div>
                            </div>
                            <label class="col-sm-2 control-label">ACS username<font color="#FF0000"></font></label>
                            <div class="col-sm-2">
                                <input type="text" class="form-control" name="acs_username" id="acs_username" value=''  >
                                <div class="errorValidation" id="error_acs_username">ACS User Name is required</div> 
                            </div>
                            <label class="col-sm-2 control-label">ACS password<font color="#FF0000"></font></label>
                            <div class="col-sm-1">
                                <input type="text" class="form-control" name="acs_password" id="acs_password" value=''  >
                                <div class="errorValidation" id="error_acs_password">ACS Password is required</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">                            
                        <div class="col-sm-12" name="home_controller_usp" id="home_controller_usp">
                            <label class="col-sm-2 control-label">Reference to tenant hosting ticket or golden copy rule in database (filtered by customer name)<font color="#FF0000"></font></label>
                            <div class="col-sm-10">
                                <select  class='form-control boengDropDown' name="tenant_ref" id="tenant_ref">
                                    <option value=""></option> 
                                </select>
                                <div class="errorValidation" id="error_tenant_ref">Platform is required</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">                            
                        <div class="col-sm-12" name="rd_party_usp" id="rd_party_usp">
                            <label class="col-sm-2 control-label">USP Controller address<font color="#FF0000"></font></label>
                            <div class="col-sm-4">
                                <input type="text" class="form-control" name="usp_addr" id="usp_addr" value=''  >
                                <div class="errorValidation" id="error_usp_addr">USP Addr is required</div> 
                            </div>
                            <label class="col-sm-2 control-label">USP Controller port<font color="#FF0000"></font></label>
                            <div class="col-sm-4">
                                <input type="text" class="form-control" name="usp_port" id="usp_port" value=''  >
                                <div class="errorValidation" id="error_usp_port">USP Port is required</div>
                            </div>
                        </div>
                    </div>                      
                    <div class="form-group">                            
                        <label class="col-sm-2 control-label">Automatic SW updates with OTA?<font color="#FF0000"></font></label>
                        <div class="col-sm-10">
                            <!-- <div class="input-group mb-3"> -->
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input otaradio" type="radio" name="auto_upgrade" id="auto_upgrade_1">
                                    <label class="form-check-label" for="auto_upgrade_1">Yes. Nokia will push a SW update twice a year (1st of August and 1st of May) to the device or earlier on request of the customer</label>
                                </div>                            
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input otaradio" type="radio" name="auto_upgrade" id="auto_upgrade_2">
                                    <label class="form-check-label" for="auto_upgrade_2">No, the customer will manage the SW of the device itself (SW lifecycle management of Home Controller, ACS or USP)</label>
                                </div>
                                <div class="errorValidation" id="error_OTA">OTA option is required</div>                          
                            <!-- </div> -->
                        </div>
                        <div class="col-sm-12" name="ota_yes_1" id="ota_yes_1">
                            <label class="col-sm-2 control-label">Is there a separate license for OTA included or explicit BBD approval to allow OTA for this product?<font color="#FF0000"></font></label>
                            <div class="col-sm-3">
                                <select class="input-sm boengDropDown" name='separate_license' id='separate_license'>
                                    <option value='' selected="selected"></option>
                                    <option value="Yes" >Yes</option>
                                    <option value="No" >No</option>
                                </select>
                                <div class="errorValidation" id="error_separate_license">Separate license is required</div>
                            </div>
                        </div>                            
                        <div class="col-sm-12" name="ota_yes_2" id="ota_yes_2">
                            <label class="col-sm-2 control-label">Will this device also be used as extender to other root Beacons?<font color="#FF0000"></font></label>
                            <div class="input-group col-sm-10">
                                <div class="form-check form-check-inline">
                                    &nbsp;&nbsp;<input class="form-check-input extenderradio" type="radio" name="used_as_extender" id="used_as_extender_y">
                                    <label class="form-check-label" for="used_as_extender_y">Yes</label>
                                </div>                            
                                <div class="form-check form-check-inline">
                                    &nbsp;&nbsp;<input class="form-check-input extenderradio" type="radio" name="used_as_extender" id="used_as_extender_n">
                                    <label class="form-check-label" for="used_as_extender_n">No</label>
                                </div>
                                <div class="errorValidation" id="error_extender">Extender option is required</div>                            
                            </div>
                            <div class="col-sm-12" name="root_beacon_1" id="root_beacon_1">
                                <div class="form-group">
                                    <div class="col-sm-12">
                                        <div class="form-group">
                                            <label class="col-sm-2 control-label">Root Beacon model#1<font color="#FF0000"></font></label>
                                            <div class="col-sm-8">
                                                <select  class='form-control boengDropDown' name="root_beacon_model" id="root_beacon_model1">
                                                    <option value=""></option> 
                                                </select>
                                                <div class="errorValidation" id="error_root_beacon_model1">Root Beacon model#1 is required</div>
                                            </div>
                                            <div class="col-sm-2">
                                                <input class="btn btn-sm whitetext info" type="button" name="add_beacon" id="add_beacon" value="Add Another Root Beacon" onClick="add_root_beacon()">
                                                <input type="hidden" class="form-control" name="Flag1" id="Flag1" value=''>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-12" name="root_beacon_2" id="root_beacon_2">
                                        <div class="form-group">
                                            <label class="col-sm-2 control-label">Root Beacon model#2<font color="#FF0000"></font></label>
                                            <div class="col-sm-8">
                                                <select  class='form-control boengDropDown' name="root_beacon_model" id="root_beacon_model2">
                                                    <option value=""></option> 
                                                </select>
                                                <div class="errorValidation" id="error_root_beacon_model2">Root Beacon model#2 is required</div>
                                            </div>
                                            <div class="col-sm-2">
                                                <input class="btn whitetext danger" type="button" value='Delete' id='delete_model2' onClick="delete_root_beceacon(this.id); return false;"> 
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-12" name="root_beacon_3" id="root_beacon_3">
                                        <div class="form-group">
                                            <label class="col-sm-2 control-label">Root Beacon model#3<font color="#FF0000"></font></label>
                                            <div class="col-sm-8">
                                                <select  class='form-control boengDropDown' name="root_beacon_model" id="root_beacon_model3">
                                                    <option value=""></option> 
                                                </select>
                                                <div class="errorValidation" id="error_root_beacon_model3">Root Beacon model#3 is required</div>
                                            </div>
                                            <div class="col-sm-2">
                                                <input class="btn whitetext danger" type="button" value='Delete' id='delete_model3' onClick="delete_root_beceacon(this.id); return false;"> 
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-12" name="root_beacon_4" id="root_beacon_4">
                                        <div class="form-group">
                                            <label class="col-sm-2 control-label">Root Beacon model#4<font color="#FF0000"></font></label>
                                            <div class="col-sm-8">
                                                <select  class='form-control boengDropDown' name="root_beacon_model" id="root_beacon_model4">
                                                    <option value=""></option> 
                                                </select>
                                                <div class="errorValidation" id="error_root_beacon_model4">Root Beacon model#4 is required</div>
                                            </div>
                                            <div class="col-sm-2">
                                                <input class="btn whitetext danger" type="button" value='Delete' id='delete_model4' onClick="delete_root_beceacon(this.id); return false;"> 
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-12" name="root_beacon_5" id="root_beacon_5">
                                        <div class="form-group">
                                            <label class="col-sm-2 control-label">Root Beacon model#5<font color="#FF0000"></font></label>
                                            <div class="col-sm-8">
                                                <select  class='form-control boengDropDown' name="root_beacon_model" id="root_beacon_model5">
                                                    <option value=""></option> 
                                                </select>
                                                <div class="errorValidation" id="error_root_beacon_model5">Root Beacon model#5 is required</div>
                                            </div>
                                            <div class="col-sm-2">
                                                <input class="btn whitetext danger" type="button" value='Delete' id='delete_model5' onClick="delete_root_beceacon(this.id); return false;"> 
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-12" name="root_beacon_6" id="root_beacon_6">
                                        <div class="form-group">
                                            <label class="col-sm-2 control-label">Root Beacon model#6<font color="#FF0000"></font></label>
                                            <div class="col-sm-8">
                                                <select  class='form-control boengDropDown' name="root_beacon_model" id="root_beacon_model6">
                                                    <option value=""></option> 
                                                </select>
                                                <div class="errorValidation" id="error_root_beacon_model6">Root Beacon model#6 is required</div>
                                            </div>
                                            <div class="col-sm-2">
                                                <input class="btn whitetext danger" type="button" value='Delete' id='delete_model6' onClick="delete_root_beceacon(this.id); return false;"> 
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-12" name="root_beacon_7" id="root_beacon_7">
                                        <div class="form-group">
                                            <label class="col-sm-2 control-label">Root Beacon model#7<font color="#FF0000"></font></label>
                                            <div class="col-sm-8">
                                                <select  class='form-control boengDropDown' name="root_beacon_model" id="root_beacon_model7">
                                                    <option value=""></option> 
                                                </select>
                                                <div class="errorValidation" id="error_root_beacon_model7">Root Beacon model#7 is required</div>
                                            </div>
                                            <div class="col-sm-2">
                                                <input class="btn whitetext danger" type="button" value='Delete' id='delete_model7' onClick="delete_root_beceacon(this.id); return false;"> 
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-12" name="root_beacon_8" id="root_beacon_8">
                                        <div class="form-group">
                                            <label class="col-sm-2 control-label">Root Beacon model#8<font color="#FF0000"></font></label>
                                            <div class="col-sm-8">
                                                <select  class='form-control boengDropDown' name="root_beacon_model" id="root_beacon_model8">
                                                    <option value=""></option> 
                                                </select>
                                                <div class="errorValidation" id="error_root_beacon_model8">Root Beacon model#8 is required</div>
                                            </div>
                                            <div class="col-sm-2">
                                                <input class="btn whitetext danger" type="button" value='Delete' id='delete_model8' onClick="delete_root_beceacon(this.id); return false;"> 
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-12" name="root_beacon_9" id="root_beacon_9">
                                        <div class="form-group">
                                            <label class="col-sm-2 control-label">Root Beacon model#9<font color="#FF0000"></font></label>
                                            <div class="col-sm-8">
                                                <select  class='form-control boengDropDown' name="root_beacon_model" id="root_beacon_model9">
                                                    <option value=""></option> 
                                                </select>
                                                <div class="errorValidation" id="error_root_beacon_model9">Root Beacon model#9 is required</div>
                                            </div>
                                            <div class="col-sm-2">
                                                <input class="btn whitetext danger" type="button" value='Delete' id='delete_model9' onClick="delete_root_beceacon(this.id); return false;"> 
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-12" name="root_beacon_10" id="root_beacon_10">
                                        <div class="form-group">
                                            <label class="col-sm-2 control-label">Root Beacon model#10<font color="#FF0000"></font></label>
                                            <div class="col-sm-8">
                                                <select  class='form-control boengDropDown' name="root_beacon_model" id="root_beacon_model10">
                                                    <option value=""></option> 
                                                </select>
                                                <div class="errorValidation" id="error_root_beacon_model10">Root Beacon model#10 is required</div>
                                            </div>
                                            <div class="col-sm-2">
                                                <input class="btn whitetext danger" type="button" value='Delete' id='delete_model10' onClick="delete_root_beceacon(this.id); return false;"> 
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">Additional information</label>
                            <div class="col-sm-8">    
                                <input type="text" class="form-control" name="additional" id="additional" value=''  >                                                    
                            </div>    
                        </div>

                    </div>
                    <div class="hr-line-dashed"></div>
                    <div class="errorValidation" id="error_all"></div>

                        <div class="form-group" >
                            <div class="col-sm-4 col-sm-offset-2">
                                <input class="btn whitetext success" type="submit" value=' Submit ' name='cmd' id='cmd' onClick="save(); return false;">
                                <input class='btn whitetext warning' type="button" name="Cancel" value="Cancel" onClick="history.go(-1);"></td>
                            </div>
                        </div>
                    </div>
                </div>
        </div>
    </div>
</div>
</form>
<script src="js/jquery.min.js?v=2.1.4"></script>
<script src="js/jquery.cookie.js"></script>
<script src="js/bootstrap.min.js?v=3.3.7"></script>
<script src="js/bootstrap-select.js"></script>
<script src="js/addon.js"></script>

<script >
	String.prototype.replaceAll = function (s1, s2) {
        return this.replace(new RegExp(s1, "gm"), s2);
    };
    
    

    function show_div(){ 	         
        hide_whitelisting_elements();
        hide_boeng_option_elements();
        hide_auto_ota();
    } 

    var cookie_name = "username";
    var cookie_mail = "mail"; 
    var flag = 0;
    var b_id = decode_bid(location.search);

    var nwcc_saas = new Map();
    var global_csv_file = '';

    //alert(b_id)
    function decode_bid(ss) {
        var id = decodeURI(ss).split('=')[1];
        return id
    }

    window.onload = initialize_page();

    function initialize_page() {
        //document.body.style.cursor='wait';

        show_div();
        fetch_customer();
        fetch_device();
        fetch_nwcc_saas();
        fetch_opid();
        if (b_id.length > 0) {
            fetch_boengrule_info();
        }
        $("#preloader").hide();
        $("#mainpart").show();

        //document.body.style.cursor='default';
    }
    function fetch_boengrule_info() {
        $.getJSON("gpi/allocate/fetch_boengrule",{"B_ID": b_id, 'type': '0'}, function (data) {
            //$("#Customer").prop('value', data.data.items[0].Customer)
            //$("#device").prop('value', data.data.items[0].device);
            let customer = data.data.items[0].Customer;
            document.formxl.Customer.value = customer;
            const l_device = String(data.data.items[0].device);
            document.formxl.device.value = l_device;
            // console.log('l_device=',l_device,'l_device.length=',l_device.length)
            // $("#device").val(l_device);

            render_nwcc(customer);            
            $("#OPID").prop('value', data.data.items[0].OPID);
            $("#whitelistmethod").prop('value', data.data.items[0].whitelistmethod);
            if (data.data.items[0].country_id) {
                $("#country_id").hide();
            } else {
                $("#country_id").show();
            }
            $("#countryid").prop('value', data.data.items[0].countryid)
            if (data.data.items[0].ip_range) {
                $("#ip_range").hide();
            }  else {
                $("#ip_range").show();
            }
            $("#iprange").prop('value', data.data.items[0].iprange)
            if (data.data.items[0].serial_number) {
                $("#serial_number").hide();
            } else {
                $("#serial_number").show();
            }
            $("#customer_name").prop('value', data.data.items[0].customer_name)
            //$("#csv_file").prop('value', data.data.items[0].csv_file)
            global_csv_file = data.data.items[0].csv_file;
            var html = '<p><a href="gpi/allocate/download?file=' +
                global_csv_file + '">' + global_csv_file + '</a></p>';
            if (data.data.items[0].csv_file.length > 0) {
                $("#csv_url").html(html);
            };
            if (data.data.items[0].tr069) {
                $("#tr069").prop('checked', true);
            }
            if (data.data.items[0].home_controller) {
                $("#home_controller").prop('checked', true);
            }
            if (data.data.items[0].rd_party_controller) {
                $("#rd_party_controller").prop('checked', true);
            }
            if (data.data.items[0].tr069_acs) {
                $("#tr069_acs").hide();
            } else {
                $("#tr069_acs").show();
            }
            $("#acs_url").prop('value', data.data.items[0].acs_url);
            $("#acs_username").prop('value', data.data.items[0].acs_username);
            $("#acs_password").prop('value', data.data.items[0].acs_password);
            if (data.data.items[0].home_controller_usp) {
                $("#home_controller_usp").hide();
            } else {
                $("#home_controller_usp").show();
            }
            $("#tenant_ref").prop('value', data.data.items[0].tenant_ref);
            if (data.data.items[0].rd_party_usp) {
                $("#rd_party_usp").hide();
            } else {
                $("#rd_party_usp").show();
            }
            $("#usp_addr").prop('value', data.data.items[0].usp_addr);
            $("#usp_port").prop('value', data.data.items[0].usp_port);
            if (data.data.items[0].auto_upgrade) {
                $("#auto_upgrade_1").prop('checked', true);
            } else {
                $("#auto_upgrade_2").prop('checked', true);
            }
            if (data.data.items[0].ota_yes_1) {
                $("#ota_yes_1").hide();
            } else {
                $("#ota_yes_1").show();
            }
            if (data.data.items[0].separate_license) {
                $("#separate_license").prop('value', 'Yes');
            } else {
                $("#separate_license").prop('value', 'No');
            }
            if (data.data.items[0].ota_yes_2) {
                $("#ota_yes_2").hide();
            } else {
                $("#ota_yes_2").show();
            }
            if (data.data.items[0].used_as_extender) {
                $("#used_as_extender_y").prop('checked', true);
            } else {
                $("#used_as_extender_n").prop('checked', true);
            }
            root_beacon_flags = data.data.items[0].root_beacon_flags.split('###')
            root_beacon_model = data.data.items[0].root_beacon_model.split('###')

            for (let i = 0; i < root_beacon_flags.length; i++) {
                if (root_beacon_flags[i] == '0') {
                    let item_flag = "#root_beacon_" + (i+1)
                    let item_value = "#root_beacon_model" + (i+1)
                    $(item_flag).show();
                    $(item_value).prop('value', root_beacon_model[i]);


                    if (i == (root_beacon_flags.length - 1)) {
                        $("#add_beacon").attr('disabled', 'disabled');
                    }
                };
            }

            $("#additional").prop('value', data.data.items[0].additional);
        });
    }

    function fetch_customer(){
        $.ajaxSetup({
            async: false
        });       
        
        $.getJSON("gpi/allocate/customer_list", {"type": "4","customer":"ALL"}, function (data) {
        //alert('Result' + JSON.stringify(data));
        
            for(var i = 0; i < data.data.items.length; i++){
                //alert('Item ' + data.data.items[i])	   
                for(let value of Object.values(data.data.items[i])){       
                    document.formxl.Customer.options[document.formxl.Customer.length]=new Option( value );
                }
            }   
        });
        $.ajaxSetup({
            async: true
        });       
    };
     
    function fetch_device(){
        mail = $.cookie(cookie_mail)
        $.ajaxSetup({
            async: false
        });       
        $.getJSON("gpi/allocate/devicelist", {"type": "0"},function(data){      	
            for(var i = 0; i < data.data.items.length; i++){
                //alert('Item ' + data.data.items[i])	   
                for(let value of Object.values(data.data.items[i])){     
                    //console.log("value=",value.trim(),'length=',value.trim().length) 
                    document.formxl.device.options[document.formxl.device.length]=new Option( value.trim() );
                    for (let j=1; j<=10; j++) {
                        let elem = 'root_beacon_model' + j;
                        document.formxl[elem].options[document.formxl[elem].length]=new Option( value.trim() );
                    }
                }
            }   	
        })
        $.ajaxSetup({
            async: true
        });       

    };

    function fetch_nwcc_saas(){
        $.ajaxSetup({
            async: false
        });       
        $.getJSON("gpi/allocate/nwcc_list", {"type": "4"}, function (data) {
            for(let i=0; i<data.data.items.length; i++){
                 let Customer = data.data.items[i]['Customer'];
                 let Platform = data.data.items[i]['Platform'];
                 if (nwcc_saas.has(Customer)) {
                    if (!nwcc_saas.get(Customer).Platform.includes(Platform)) {
                        nwcc_saas.get(Customer).Platform.push(Platform)
                    }
                 } else {
                    nwcc_saas.set(Customer,{
                        Platform: [Platform]
                    });
                 }
            };  
        });
        $.ajaxSetup({
            async: true
        });
    }

    function fetch_opid(){
        $.ajaxSetup({
            async: false
        });       
        $.getJSON("gpi/allocate/opid_list", {"type": "4"}, function (data) {
            for(let i=0; i<data.data.items.length; i++){
                document.formxl.OPID.options[document.formxl.OPID.length]=new Option(
                    data.data.items[i]['OPID'].trim()
                );
            };  
        });
        $.ajaxSetup({
            async: true
        });
    }

    $("#csv_file").change(function(e){
        //alert("CSV file");
        upload();
    });

    function upload() {
        var csv=$("#csv_file")[0].files[0];
        if (csv.name.length <= 0) {
            return;
        }
        var data = new FormData();
        data.append('file', csv);
        global_csv_file = csv.name;
        var html = '<p><a href="gpi/allocate/download?file=' +
            global_csv_file + '">' + global_csv_file + '</a></p>';

        $.ajax({
            url: "gpi/allocate/csv_upload",
            type: "POST",
            data: data,
            contentType: false,
            cache: false,
            processData: false,
            success: function(msg) {
                $("#csv_url").html(html);
                $("#csv_file_label").text(global_csv_file + " uploaded OK.");
            }
        });

    };

    function pre_validation() {
        // make sure all input are not empty and valid
        // const alert_html = '<font color="#FF0000" size="4">*</font>';
        // const pass_html = '';
        var count = 0;
        if (document.formxl.Customer.value.trim().length <= 0) {
            $("#error_Customer").show();
            count++;
        } else {
            $("#error_Customer").hide();
        };
        if (document.formxl.device.value.trim().length <= 0) {
            $("#error_device").show();
            count++;
        } else {
            $("#error_device").hide();
        };
        if (document.formxl.OPID.value.trim().length <= 0) {
            $("#error_OPID").show();
            count++;
        } else {
            $("#error_OPID").hide();
        };
        if (document.formxl.whitelistmethod.value.trim().length <= 0) {
            $("#error_whitelistmethod").show();
            count++;
        } else {
            $("#error_whitelistmethod").hide();
        };

        if (!($("#country_id").is(':hidden'))) {
            if (document.formxl.countryid.value.trim().length <= 0) {
                $("#error_countryid").show();
                count++;
            } else {
                $("#error_countryid").hide();
            };
        };

        if (!($("#ip_range").is(':hidden'))) {
            if (document.formxl.iprange.value.trim().length <= 0) {
                $("#error_iprange").show();
                count++;
            } else {
                $("#error_iprange").hide();
            };
        };

        if (!($("#serial_number").is(':hidden'))) {
            if (!(document.formxl.customer_name.value.trim().length > 0 || 
                document.formxl.csv_file.value.trim().length > 0 ||
                global_csv_file.trim().length > 0
                )) {
                $("#error_customer_name").show();
                count++;
            } else {
                $("#error_customer_name").hide();
            };
        };

        if (!($("#tr069").is(':checked') || $("#home_controller").is(':checked') || $("#rd_party_controller").is(':checked'))) {
            $("#error_boeng_option").show();
            count++;
        } else {
            $("#error_boeng_option").hide();
        };

        if (!($("#tr069_acs").is(':hidden'))) {
            if (document.formxl.acs_url.value.trim().length <= 0) {
                $("#error_acs_url").show();
                count++;
            } else {
                $("#error_acs_url").hide();
            };
            if (document.formxl.acs_username.value.trim().length <= 0) {
                $("#error_acs_username").show();
                count++;
            } else {
                $("#error_acs_username").hide();
            };
            if (document.formxl.acs_password.value.trim().length <= 0) {
                $("#error_acs_password").show();
                count++;
            } else {
                $("#error_acs_password").hide();
            };
        };

        if (!($("#home_controller_usp").is(':hidden'))) {
            if (document.formxl.tenant_ref.value.trim().length <= 0) {
                $("#error_tenant_ref").show();
                count++;
            } else {
                $("#error_tenant_ref").hide();
            };
        };

        if (!($("#rd_party_usp").is(':hidden'))) {
            if (document.formxl.usp_addr.value.trim().length <= 0) {
                $("#error_usp_addr").show();
                count++;
            } else {
                $("#error_usp_addr").hide();
            };
            if (document.formxl.usp_port.value.trim().length <= 0) {
                $("#error_usp_port").show();
                count++;
            } else {
                $("#error_usp_port").hide();
            };
        };

        if (!($("#auto_upgrade_1").is(':checked') || $("#auto_upgrade_2").is(':checked'))) {
            $("#error_OTA").show();
            count++;
        } else {
            $("#error_OTA").hide();
        };

        if (!($("#ota_yes_1").is(':hidden'))) {
            if (document.formxl.separate_license.value.trim().length <= 0) {
                $("#error_separate_license").show();
                count++;
            } else {
                $("#error_separate_license").hide();
            };
        };

        if (!($("#ota_yes_2").is(':hidden'))) {
            if (!($("#used_as_extender_y").is(':checked') || $("#used_as_extender_n").is(':checked'))) {
                $("#error_extender").show();
                count++;
            } else {
                $("#error_extender").hide();
            };

            if ($("#used_as_extender_y").is(':checked')) {
                for (let i=1; i<=10; i++) {
                    let flag_div = "#root_beacon_" + i;
                    let value_div = "root_beacon_model" + i;
                    let error_div = "#error_root_beacon_model" + i;
                    //console.log(flag_div + ", is.hidden = " + $(flag_div).is(":hidden"));
                    if (!($(flag_div).is(":hidden"))) {
                        if (document.formxl[value_div].value.trim().length <= 0) {
                            $(error_div).show();
                            count++;
                        } else {
                            $(error_div).hide();
                        };
                    };
                };
            };
        };

        if (count > 0) {
            $("#error_all").text("You have " + count + " error(s) in this form!");
            $("#error_all").show();
            return false;
        } else {
            $("#error_all").text("");
            $("#error_all").hide();
            return true;
        };
    };

    function save() {
        let res = pre_validation();
        if (!res) {
            return;
        };
        mail = $.cookie(cookie_mail);
        const url = 'gpi/allocate/new_boeng_edit';;
        const root_beacon_model = [
            document.formxl.root_beacon_model1.value,
            document.formxl.root_beacon_model2.value,
            document.formxl.root_beacon_model3.value,
            document.formxl.root_beacon_model4.value,
            document.formxl.root_beacon_model5.value,
            document.formxl.root_beacon_model6.value,
            document.formxl.root_beacon_model7.value,
            document.formxl.root_beacon_model8.value,
            document.formxl.root_beacon_model9.value,
            document.formxl.root_beacon_model10.value,
        ];
        const root_beacon_flags = [
            ($("#root_beacon_1").is(':hidden'))?'1':'0',
            ($("#root_beacon_2").is(':hidden'))?'1':'0',
            ($("#root_beacon_3").is(':hidden'))?'1':'0',
            ($("#root_beacon_4").is(':hidden'))?'1':'0',
            ($("#root_beacon_5").is(':hidden'))?'1':'0',
            ($("#root_beacon_6").is(':hidden'))?'1':'0',
            ($("#root_beacon_7").is(':hidden'))?'1':'0',
            ($("#root_beacon_8").is(':hidden'))?'1':'0',
            ($("#root_beacon_9").is(':hidden'))?'1':'0',
            ($("#root_beacon_10").is(':hidden'))?'1':'0',
        ];
        
        // let csv_file = "";
        // if ($("#csv_file").length > 0) {
        //     csv_file = $("#csv_file")[0].files[0].name;
        // };
        var data = {
            mail: mail,
            Customer: document.formxl.Customer.value,
            device: document.formxl.device.value,
            OPID: document.formxl.OPID.value,
            whitelistmethod: document.formxl.whitelistmethod.value,
            country_id: $("#country_id").is(':hidden'),
            countryid: document.formxl.countryid.value,
            ip_range: $("#ip_range").is(':hidden'),
            iprange: document.formxl.iprange.value,
            serial_number: $("#serial_number").is(':hidden'),
            customer_name: document.formxl.customer_name.value,
            csv_file: global_csv_file,
            tr069: $("#tr069").is(':checked'),
            home_controller: $("#home_controller").is(':checked'),
            rd_party_controller: $("#rd_party_controller").is(':checked'),
            tr069_acs: $("#tr069_acs").is(':hidden'),
            acs_url: document.formxl.acs_url.value,
            acs_username: document.formxl.acs_username.value,
            acs_password: document.formxl.acs_password.value,
            home_controller_usp: $("#home_controller_usp").is(':hidden'),
            tenant_ref: document.formxl.tenant_ref.value,
            rd_party_usp: $("#rd_party_usp").is(':hidden'),
            usp_addr: document.formxl.usp_addr.value,
            usp_port: document.formxl.usp_port.value,
            auto_upgrade: $("#auto_upgrade_1").is(':checked'),
            ota_yes_1: $("#ota_yes_1").is(':hidden'),
            separate_license: (document.formxl.separate_license.value == "Yes")? true:false,
            ota_yes_2: $("#ota_yes_2").is(':hidden'),
            used_as_extender: $("#used_as_extender_y").is(':checked'),
            root_beacon_flags: root_beacon_flags.join('###'),
            root_beacon_model: root_beacon_model.join('###'),
            ota_yes_4: $("#ota_yes_4").is(':hidden'),
            additional: document.formxl.additional.value
        };

        var action = ''
        if (b_id.length > 0) {
            // Edit mode
            data.type = '2';
            data.B_ID = b_id;
            data.modifier = mail;
            data.modifiedon = get_ts();
            action = 'Modify'
        } else {
            // Add mode
            data.type = '10';
            data.creator = mail;
            data.createon = get_ts();
            action = 'Add'
        }
        
        sendPost(url, data, action);
    };


    async function sendPost(url, data, action) {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });            
        const result = await response.json();
        resp = result.data.status;                    
        if (resp.includes('successful')) {
            alert(action + " OK!");
            if ('referrer' in document) {
                window.location = document.referrer
            } else {
                window.location.reload(history.back());
            }
        }else{
            alert(resp);
        }

    };      

    $(function () { $("[data-toggle='popover']").popover(); });

    function removeOptions(elem) {
        for (let i=elem.options.length-1; i>0; i--) {
            elem.remove(i);
        }
    };

    function render_nwcc(cus) {
        if (nwcc_saas.has(cus)) {
            for (let i=0; i<nwcc_saas.get(cus).Platform.length; i++) {
                if (nwcc_saas.get(cus).Platform[i] != "") {
                    document.formxl.tenant_ref.options[document.formxl.tenant_ref.length]=new Option(
                        nwcc_saas.get(cus).Platform[i]
                    );
                }
            };
        } 
    };

    $("#Customer").change(function(){    
        var customer = ($("#Customer").val());

        removeOptions(document.formxl.tenant_ref);
        render_nwcc(customer);
    });


    $("#whitelistmethod").change(function(){    
        var list_method = ($("#whitelistmethod").val());
        switch(list_method) {
            case "":
                hide_whitelisting_elements("");
                break;
            case "Dedicated OPID":
                hide_whitelisting_elements("");
                break;
            case "Country ID":
                hide_whitelisting_elements("country_id");
                $("#country_id").show();
                break;
            case "IP based":
                hide_whitelisting_elements("ip_range");
                $("#ip_range").show();
                break;
            case "Serial number":
                hide_whitelisting_elements("serial_number");
                $("#serial_number").show();
                break;
        }
  
    });

    $("#tr069").change(function(){    
        if(this.checked) {
            $("#tr069_acs").show();
        } else {
            $("acs_url").val(null);
            // $("acs_url").prop("value", " ");
            // $("acs_url").val('xyz');
            document.formxl.acs_url.value = "";
            document.formxl.acs_username.value = "";
            document.formxl.acs_password.value = "";
            $("acs_username").val('');
            $("acs_password").val('');
            $("#tr069_acs").hide();
        }
    })
    $("#home_controller").change(function(){    
        if(this.checked) {
            $("#home_controller_usp").show();
            if ($("#auto_upgrade_1").is(':checked')) {
                $("#ota_yes_1").hide();
                document.formxl.separate_license.value = "";
                $("#separate_license").prop("value", "");
            }
        } else {
            $("#home_controller_usp").hide();
            document.formxl.tenant_ref.value = "";
            $("#tenant_ref").prop("value", "");
            if ($("#auto_upgrade_1").is(':checked')) {
                $("#ota_yes_1").show();
            }
        }
    })
    $("#rd_party_controller").change(function(){    
        if(this.checked) {
            $("#rd_party_usp").show();
        } else {
            $("#rd_party_usp").hide();
            document.formxl.usp_addr.value = "";
            document.formxl.usp_port.value = "";
            $("#usp_addr").prop("value", "");
            $("#usp_port").prop("value", "");
        }
    })
    $(".otaradio").change(function(){
        //alert($("#home_controller").is(':checked'));
        if(this.id == "auto_upgrade_1") {
            if (!($("#home_controller").is(':checked'))) {
                $("#ota_yes_1").show();
            }
            $("#ota_yes_2").show();
        } else {
            $("#ota_yes_1").hide();
            $("#ota_yes_2").hide();
            document.formxl.separate_license.value = "";
            $("#used_as_extender_y").prop('checked', false);
            $("#used_as_extender_n").prop('checked', false);
            clear_all_root_beacon_models();
        }
    })
    function clear_all_root_beacon_models() {
        for (let i=1; i<=10; i++) {
            let item_value = "root_beacon_model" + i;
            let item_flag = "#root_beacon_" + i;
            document.formxl[item_value].value = "";
            $(item_value).prop("value", "");
            $(item_flag).hide();
        }
        $("#add_beacon").attr('disabled', false);
    }
    $(".extenderradio").change(function(){
        //alert($("#home_controller").is(':checked'));
        if(this.id == "used_as_extender_y") {
            $("#root_beacon_1").show();
        } else {
            // $("#root_beacon_1").hide();
            // document.formxl.root_beacon_model1.value = "";
            clear_all_root_beacon_models();
        }
    })

    function hide_whitelisting_elements(elem) {
        $("#country_id").hide();
        $("#ip_range").hide();
        $("#serial_number").hide();
        switch (elem) {
            case "":
                document.formxl.countryid.value = "";
                document.formxl.iprange.value = "";
                document.formxl.customer_name.value = "";
                $("#countryid").prop("value", "");
                $("#iprange").prop("value", "");
                $("#customer_name").prop("value", "");
                break;
            case "country_id":
                document.formxl.iprange.value = "";
                document.formxl.customer_name.value = "";
                $("#iprange").prop("value", "");
                $("#customer_name").prop("value", "");
                break;
            case "ip_range":
                document.formxl.countryid.value = "";
                document.formxl.customer_name.value = "";
                $("#countryid").prop("value", "");
                $("#customer_name").prop("value", "");
                break;
            case "serial_number":
                document.formxl.countryid.value = "";
                document.formxl.iprange.value = "";
                $("#countryid").prop("value", "");
                $("#iprange").prop("value", "");
                break;
        }
    }

    function hide_boeng_option_elements() {
        $("#tr069_acs").hide();
        $("#home_controller_usp").hide();
        $("#rd_party_usp").hide();
    }

    function hide_auto_ota() {
        $("#ota_yes_1").hide();
        $("#ota_yes_2").hide();
        for (let i=1; i<=10; i++) {
            let elem = "#root_beacon_" + i;
            $(elem).hide();
        }
    }

    function add_root_beacon() {
        if ($("#root_beacon_2").is(":hidden")) {
            $("#root_beacon_2").show();
        } else if ($("#root_beacon_3").is(":hidden")) {
            $("#root_beacon_3").show();
        } else if ($("#root_beacon_4").is(":hidden")) {
            $("#root_beacon_4").show();
        } else if ($("#root_beacon_5").is(":hidden")) {
            $("#root_beacon_5").show();
        } else if ($("#root_beacon_6").is(":hidden")) {
            $("#root_beacon_6").show();
        } else if ($("#root_beacon_7").is(":hidden")) {
            $("#root_beacon_7").show();
        } else if ($("#root_beacon_8").is(":hidden")) {
            $("#root_beacon_8").show();
        } else if ($("#root_beacon_9").is(":hidden")) {
            $("#root_beacon_9").show();
        } else if ($("#root_beacon_10").is(":hidden")) {
            $("#root_beacon_10").show();
            $("#add_beacon").attr('disabled', 'disabled');
        }
    }

    function delete_root_beceacon(id) {
        let iid = parseInt(id.replace('delete_model', ''));
        for (let i=iid; i<=10; i++) {
            let item_value = "root_beacon_model" + i;
            let item_value_next = "root_beacon_model" + (i+1);
            let item_flag = "#root_beacon_" + i;
            let item_flag_next = "#root_beacon_" + (i+1);
            if (((i+1) > 10) || $(item_flag_next).is(":hidden")) {
                document.formxl[item_value].value = "";
                $(item_value).prop("value", "");
                $(item_flag).hide();
                break;
            } else {
                document.formxl[item_value].value = document.formxl[item_value_next].value;
                $(item_value).prop("value", document.formxl[item_value_next].value);
            }
            
        }
    }

    // $("#csv_file").fileupload({
    //     add: function(e, data) {
    //         alert(data.files[0].name);
    //         var jqXHR = data.submit();
    //     }
    // });

    $("[rel=drevil]").popover({
        trigger:'manual',
        html: 'true', 
        animation: false
    }).on("mouseenter", function () {
        var _this = this;
        $(this).popover("show");
        $(this).siblings(".popover").on("mouseleave", function () {
            $(_this).popover('hide');
        });
    }).on("mouseleave", function () {
        var _this = this;
        setTimeout(function () {
            if (!$(".popover:hover").length) {
                $(_this).popover("hide")
            }
        }, );
    });
</script>

<script language="javascript">       
    window.onload = show_div();
</script>
<script>
    var myVar;
    
    function myFunction() {
      myVar = setTimeout(showPage, 3000);
    }
    
    function showPage() {
      document.getElementById("loader").style.display = "none";
      document.getElementById("myDiv").style.display = "block";
    }
</script>
</body>

</html>
